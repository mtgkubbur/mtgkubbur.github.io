---
pagetitle: "Leikmaður"
title-block-style: none
page-layout: article
toc: false
execute:
  echo: false
  warning: false
  message: false
---

```{r}
#| label: setup
library(tidyverse)
library(lubridate)
library(googlesheets4)

gs4_auth(email = Sys.getenv("GOOGLE_MAIL"))
source("R/elo_table.R")

# Only include opted-in players
table_players <- fetch_table_players()

history <- combine_player_summaries() |>
  filter(str_to_lower(player) %in% table_players)

# Per-player per-category records from processed_data (High/Medium/Low/Other)
latest <- load_results_set(rank = 1)
cube_records <- bind_rows(
  latest$processed_data |> transmute(
    player = str_to_title(player1), cube,
    win = as.integer(str_to_title(winner) == str_to_title(player1))
  ),
  latest$processed_data |> transmute(
    player = str_to_title(player2), cube,
    win = as.integer(str_to_title(winner) == str_to_title(player2))
  )
) |>
  filter(str_to_lower(player) %in% table_players) |>
  group_by(player, cube) |>
  summarise(
    wins = sum(win),
    losses = n() - sum(win),
    total = n(),
    .groups = "drop"
  ) |>
  mutate(winrate = round(wins / total * 100))

# Pass to OJS
ojs_define(player_history = history)
ojs_define(cube_records_data = cube_records)
```

```{ojs}
//| label: theme-detect
isDark = Generators.observe(notify => {
  const current = () => document.body.classList.contains("quarto-dark");
  notify(current());

  const observer = new MutationObserver(() => {
    notify(current());
  });

  observer.observe(document.body, { attributes: true, attributeFilter: ["class"] });
  return () => observer.disconnect();
})

// Theme-aware color palettes
themeColors = {
  const _ = isDark;
  const bodyStyles = getComputedStyle(document.body);
  const rootStyles = getComputedStyle(document.documentElement);
  const cssVar = (name, fallback = "") =>
    bodyStyles.getPropertyValue(name).trim() ||
    rootStyles.getPropertyValue(name).trim() ||
    fallback;

  return {
    blue: cssVar("--mtg-blue", "#0e68ab"),
    green: cssVar("--mtg-green", "#00733e"),
    red: cssVar("--mtg-red", "#d3202a"),
    gold: cssVar("--mtg-gold", "#8b6914"),
    text: cssVar("--text-primary", "#2a1f14"),
    muted: cssVar("--text-muted", "#5c4f42"),
    grid: cssVar("--chart-grid", "#d4cfc9"),
    blueArea1: cssVar("--chart-blue-area-1", "rgba(14, 104, 171, 0.12)"),
    blueArea2: cssVar("--chart-blue-area-2", "rgba(14, 104, 171, 0.25)")
  };
}
```

```{ojs}
//| label: data-prep
cubeRecords = transpose(cube_records_data).map(d => ({
  ...d,
  wins: +d.wins,
  losses: +d.losses,
  total: +d.total,
  winrate: +d.winrate
}))

data = {
  const raw = transpose(player_history);
  return raw.map(d => ({
    ...d,
    date: new Date(d.date),
    score_median: +d.score_median,
    score_q25: +d.score_q25,
    score_q75: +d.score_q75,
    score_lower: +d.score_lower,
    score_upper: +d.score_upper,
    wins: +d.wins,
    losses: +d.losses,
    total: +d.total,
    winRate: +d.total > 0 ? (+d.wins / +d.total) * 100 : 0,
    gamma_High: d.gamma_High != null ? +d.gamma_High : null,
    gamma_Medium: d.gamma_Medium != null ? +d.gamma_Medium : null,
    gamma_Low: d.gamma_Low != null ? +d.gamma_Low : null,
    gamma_Other: d.gamma_Other != null ? +d.gamma_Other : null
  }));
}

// Get sorted unique player names
players = [...new Set(data.map(d => d.player))].sort((a, b) =>
  a.localeCompare(b, "is")
)

// Compute placement (rank by score_median descending) per date
ranks = {
  const byDate = d3.group(data, d => +d.date);
  const result = new Map();
  for (const [dateKey, rows] of byDate) {
    const sorted = [...rows].sort((a, b) => b.score_median - a.score_median);
    sorted.forEach((d, i) => {
      result.set(`${d.player}_${dateKey}`, i + 1);
    });
  }
  return result;
}

// Add rank to each data point
dataWithRank = data.map(d => ({
  ...d,
  rank: ranks.get(`${d.player}_${+d.date}`) || null
}))

// Global domains
xDomain = d3.extent(data, d => d.date)

yDomain = [
  d3.min(data, d => d.score_lower),
  d3.max(data, d => d.score_upper)
]

maxPlayers = d3.max([...d3.group(data, d => +d.date).values()], rows => rows.length)
```

:::: {.page-header}

```{=html}
<div class="mana-pips">
  <i class="ms ms-w mana-pip-w"></i>
  <i class="ms ms-u mana-pip-u"></i>
  <i class="ms ms-b mana-pip-b"></i>
  <i class="ms ms-r mana-pip-r"></i>
  <i class="ms ms-g mana-pip-g"></i>
</div>
```

# Leikmaður {.title}

[Þróun og tölfræði einstakra leikmanna]{.page-desc}

::::

```{ojs}
//| label: player-selector
viewof selectedPlayer = Inputs.select(["", ...players], {
  label: "Leikmaður:",
  value: "",
  format: d => d === "" ? "Veldu leikmann..." : d
})
```

```{ojs}
//| label: selected-data
playerData = selectedPlayer === ""
  ? []
  : dataWithRank
      .filter(d => d.player === selectedPlayer)
      .sort((a, b) => a.date - b.date)

latest = playerData.length > 0 ? playerData[playerData.length - 1] : null
```

```{ojs}
//| label: player-summary
{
  if (!latest) {
    return html`<div class="empty-state">
      <div class="empty-icon">&#9876;</div>
      <div>Veldu leikmann til að sjá upplýsingar</div>
    </div>`;
  }

  const cubeTypes = [
    { key: "gamma_High", label: "High", color: themeColors.red },
    { key: "gamma_Medium", label: "Medium", color: themeColors.blue },
    { key: "gamma_Low", label: "Low", color: themeColors.green },
    { key: "gamma_Other", label: "Annað", color: themeColors.gold }
  ];

  // Find strongest cube type
  const gammas = cubeTypes
    .map(c => ({ ...c, value: latest[c.key] }))
    .filter(c => c.value != null);
  const best = gammas.length > 0
    ? gammas.reduce((a, b) => a.value > b.value ? a : b)
    : null;

  return html`<div class="player-summary">
    <div class="stat">
      <div class="stat-value" style="color: ${themeColors.blue};">${latest.score_median}</div>
      <div class="stat-label">ELO</div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color: ${themeColors.red};">#${latest.rank}</div>
      <div class="stat-label">Sæti</div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color: ${themeColors.green};">${latest.winRate.toFixed(0)}%</div>
      <div class="stat-label">Sigurhlutfall</div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color: ${themeColors.gold};">${latest.total}</div>
      <div class="stat-label">Leikir</div>
    </div>
    ${best ? html`<div class="stat">
      <div class="stat-value" style="color: ${best.color};">${best.label}</div>
      <div class="stat-label">Sterkustu kubbar</div>
    </div>` : html``}
  </div>`;
}
```

```{ojs}
//| label: cube-table
{
  if (!latest) return html``;

  const cubeTypes = [
    { key: "gamma_High", cube: "High", label: "High", color: themeColors.red },
    { key: "gamma_Medium", cube: "Medium", label: "Medium", color: themeColors.blue },
    { key: "gamma_Low", cube: "Low", label: "Low", color: themeColors.green },
    { key: "gamma_Other", cube: "Other", label: "Annað", color: themeColors.gold }
  ];

  const records = cubeRecords
    .filter(d => d.player === selectedPlayer);

  // Merge gamma + records into unified rows
  const rows = cubeTypes.map(c => {
    const rec = records.find(r => r.cube === c.cube);
    const gamma = latest[c.key];
    return {
      label: c.label,
      color: c.color,
      wins: rec ? rec.wins : 0,
      losses: rec ? rec.losses : 0,
      total: rec ? rec.total : 0,
      winrate: rec ? rec.winrate : null,
      gamma: gamma != null ? gamma : null
    };
  }).filter(r => r.total > 0 || r.gamma != null);

  if (rows.length === 0) return html``;

  const maxAbs = Math.max(0.15, d3.max(rows, d => d.gamma != null ? Math.abs(d.gamma) : 0));

  return html`<div class="cube-combined-card">
    <div class="cube-affinity-title">Árangur og styrkur eftir flokkum</div>
    <table class="cube-combined-table">
      <thead>
        <tr>
          <th></th>
          <th>S</th>
          <th>T</th>
          <th>%</th>
          <th>Styrkur</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => {
          const barPct = r.gamma != null ? Math.abs(r.gamma) / maxAbs * 40 : 0;
          const isPositive = r.gamma >= 0;
          return html`
          <tr>
            <td class="cube-record-name">
              <span class="cube-record-pip" style="background: ${r.color}"></span>
              ${r.label}
            </td>
            <td>${r.total > 0 ? r.wins : '–'}</td>
            <td>${r.total > 0 ? r.losses : '–'}</td>
            <td style="color: ${r.winrate != null ? (r.winrate >= 50 ? themeColors.green : themeColors.red) : themeColors.muted}; font-weight: 600">${r.winrate != null ? r.winrate + '%' : '–'}</td>
            <td class="gamma-cell">
              ${r.gamma != null ? html`
                <div class="gamma-bar-inline">
                  <div class="gamma-bar-neg-side">${!isPositive ? html`<div class="gamma-bar-fill" style="width: ${barPct}%; background: ${themeColors.red};"></div>` : html``}</div>
                  <div class="gamma-bar-mid"></div>
                  <div class="gamma-bar-pos-side">${isPositive ? html`<div class="gamma-bar-fill" style="width: ${barPct}%; background: ${themeColors.green};"></div>` : html``}</div>
                </div>
                <span class="gamma-val" style="color: ${r.gamma >= 0 ? themeColors.green : themeColors.red}">${r.gamma >= 0 ? '+' : ''}${r.gamma.toFixed(2)}</span>
              ` : html`<span style="color: ${themeColors.muted}">–</span>`}
            </td>
          </tr>`;
        })}
      </tbody>
    </table>
    <div class="cube-footnote">
      <strong>High:</strong> Vintage Cube, Bolti Vintage Cube, Nerva's Cube | <strong>Medium:</strong> Meta Memories, Modern Stories, Synergy Cube, Bar Cube | <strong>Low:</strong> Khans Cube, Kaldheim Cube, Old Border Cube, Pauper Cube, Ab Wheel, Horror Cube | <strong>Annað:</strong> Boltalandið, Genesis, Stone Soup Cube, Super Turbo Time
    </div>
  </div>`;
}
```

::: {.column-screen-inset .dashboard-grid style="display: none;"}
:::

```{ojs}
//| label: charts-container
//| column: screen-inset
{
  if (!latest) return html``;

  const chartStyle = {
    fontSize: "12px",
    fontFamily: "'Inter', system-ui, sans-serif",
    background: "transparent",
    color: themeColors.text
  };

  // Background color for text halo (matches card bg)
  const haloBg = isDark ? "#1e1e26" : "#ffffff";

  // Shared axis/grid mark builders for consistent styling
  const makeGridY = (opts) => Plot.gridY({
    stroke: themeColors.grid,
    strokeOpacity: 0.6,
    strokeDasharray: "3,4",
    ...opts
  });

  const makeAxisX = (opts) => Plot.axisX({
    tickSize: 4,
    tickPadding: 6,
    stroke: themeColors.grid,
    fill: themeColors.muted,
    fontVariant: "normal",
    ticks: d3.utcMonth,
    tickFormat: d => d.toLocaleDateString("is-IS", { month: "short" }),
    ...opts
  });

  const makeAxisY = (label, opts) => Plot.axisY({
    label: label,
    labelArrow: "none",
    labelAnchor: "top",
    tickSize: 0,
    tickPadding: 8,
    fill: themeColors.muted,
    textStroke: haloBg,
    textStrokeWidth: 3,
    ...opts
  });

  // Endpoint label helper — adds white halo for legibility
  const endLabel = (d, text, color) => Plot.text([d], {
    x: "date", y: text.field || Object.keys(d).find(k => typeof d[k] === "number" && k !== "rank"),
    text: () => text.value,
    dy: -14, fontSize: 12, fontWeight: 600,
    fill: color, stroke: haloBg, strokeWidth: 4
  });

  // Shared x scale (no axis — we use explicit axisX marks instead)
  const xScale = { type: "time", domain: xDomain, label: null, axis: null };

  // ── ELO chart ──
  const eloChart = Plot.plot({
    width: width, height: 380,
    marginLeft: 60, marginRight: 20, marginBottom: 40, marginTop: 12,
    style: chartStyle,
    x: xScale,
    y: { label: null, domain: yDomain, axis: null },
    color: {
      domain: ["90% bil", "50% bil", "Miðgildi"],
      range: [themeColors.blueArea1, themeColors.blueArea2, themeColors.blue],
      legend: true
    },
    marks: [
      makeGridY(),
      makeAxisX(),
      makeAxisY("ELO"),
      Plot.areaY(playerData, { x: "date", y1: "score_lower", y2: "score_upper", fill: themeColors.blueArea1, curve: "catmull-rom" }),
      Plot.areaY(playerData, { x: "date", y1: "score_q25", y2: "score_q75", fill: themeColors.blueArea2, curve: "catmull-rom" }),
      Plot.lineY(playerData, { x: "date", y: "score_median", stroke: themeColors.blue, strokeWidth: 2.5, curve: "catmull-rom" }),
      Plot.dot([latest], { x: "date", y: "score_median", fill: themeColors.blue, r: 5, stroke: haloBg, strokeWidth: 2 }),
      Plot.text([latest], { x: "date", y: "score_median", text: d => `${d.score_median}`, dy: -14, fontSize: 12, fontWeight: 600, fill: themeColors.blue, stroke: haloBg, strokeWidth: 4 })
    ]
  });

  // ── Win rate chart ──
  const winrateChart = Plot.plot({
    width: width, height: 340,
    marginLeft: 50, marginRight: 20, marginBottom: 40, marginTop: 12,
    style: chartStyle,
    x: xScale,
    y: { label: null, domain: [0, 100], axis: null },
    marks: [
      makeGridY(),
      makeAxisX(),
      makeAxisY("Sigurhlutfall (%)"),
      Plot.ruleY([50], { stroke: themeColors.muted, strokeDasharray: "6,4", strokeOpacity: 0.5 }),
      Plot.areaY(playerData, { x: "date", y1: 50, y2: "winRate", fill: themeColors.green, fillOpacity: isDark ? 0.10 : 0.12, curve: "catmull-rom" }),
      Plot.lineY(playerData, { x: "date", y: "winRate", stroke: themeColors.green, strokeWidth: 2.5, curve: "catmull-rom" }),
      Plot.dot([latest], { x: "date", y: "winRate", fill: themeColors.green, r: 5, stroke: haloBg, strokeWidth: 2 }),
      Plot.text([latest], { x: "date", y: "winRate", text: d => `${d.winRate.toFixed(0)}%`, dy: -14, fontSize: 12, fontWeight: 600, fill: themeColors.green, stroke: haloBg, strokeWidth: 4 })
    ]
  });

  // ── Placement chart ──
  const placementChart = Plot.plot({
    width: width, height: 340,
    marginLeft: 50, marginRight: 20, marginBottom: 40, marginTop: 12,
    style: chartStyle,
    x: xScale,
    y: { label: null, domain: [maxPlayers, 1], axis: null },
    marks: [
      makeGridY(),
      makeAxisX(),
      makeAxisY("Sæti"),
      Plot.areaY(playerData, { x: "date", y1: maxPlayers, y2: "rank", fill: themeColors.red, fillOpacity: isDark ? 0.08 : 0.10, curve: "catmull-rom" }),
      Plot.lineY(playerData, { x: "date", y: "rank", stroke: themeColors.red, strokeWidth: 2.5, curve: "catmull-rom" }),
      Plot.dot([latest], { x: "date", y: "rank", fill: themeColors.red, r: 5, stroke: haloBg, strokeWidth: 2 }),
      Plot.text([latest], { x: "date", y: "rank", text: d => `#${d.rank}`, dy: -14, fontSize: 12, fontWeight: 600, fill: themeColors.red, stroke: haloBg, strokeWidth: 4 })
    ]
  });

  // ── Cube affinity evolution chart ──
  const cubeTypes = [
    { key: "gamma_High", label: "High", color: themeColors.red },
    { key: "gamma_Medium", label: "Medium", color: themeColors.blue },
    { key: "gamma_Low", label: "Low", color: themeColors.green },
    { key: "gamma_Other", label: "Annað", color: themeColors.gold }
  ];

  const gammaData = playerData.flatMap(d =>
    cubeTypes
      .filter(c => d[c.key] != null)
      .map(c => ({
        date: d.date,
        cube: c.label,
        gamma: d[c.key],
        color: c.color
      }))
  );

  const gammaChart = gammaData.length > 0 ? Plot.plot({
    width: width, height: 340,
    marginLeft: 50, marginRight: 20, marginBottom: 40, marginTop: 12,
    style: chartStyle,
    x: xScale,
    y: { label: null, axis: null },
    color: {
      domain: cubeTypes.map(c => c.label),
      range: cubeTypes.map(c => c.color),
      legend: true
    },
    marks: [
      makeGridY(),
      makeAxisX(),
      makeAxisY("Kubbaáhrif (γ)"),
      Plot.ruleY([0], { stroke: themeColors.muted, strokeDasharray: "6,4", strokeOpacity: 0.5 }),
      Plot.lineY(gammaData, { x: "date", y: "gamma", stroke: "cube", strokeWidth: 2, curve: "catmull-rom" }),
      ...cubeTypes
        .filter(c => latest[c.key] != null)
        .map(c => Plot.dot([{ date: latest.date, gamma: latest[c.key] }], {
          x: "date", y: "gamma", fill: c.color, r: 4, stroke: haloBg, strokeWidth: 2
        }))
    ]
  }) : null;

  // ── Games count chart ──
  const gamesChart = Plot.plot({
    width: width, height: 340,
    marginLeft: 50, marginRight: 20, marginBottom: 40, marginTop: 12,
    style: chartStyle,
    x: xScale,
    y: { label: null, domain: [0, d3.max(playerData, d => d.total) * 1.1 || 10], axis: null },
    marks: [
      makeGridY(),
      makeAxisX(),
      makeAxisY("Fjöldi leikja"),
      Plot.areaY(playerData, { x: "date", y1: 0, y2: "total", fill: themeColors.gold, fillOpacity: isDark ? 0.10 : 0.12, curve: "step-after" }),
      Plot.lineY(playerData, { x: "date", y: "total", stroke: themeColors.gold, strokeWidth: 2.5, curve: "step-after" }),
      Plot.dot([latest], { x: "date", y: "total", fill: themeColors.gold, r: 5, stroke: haloBg, strokeWidth: 2 }),
      Plot.text([latest], { x: "date", y: "total", text: d => `${d.total}`, dy: -14, fontSize: 12, fontWeight: 600, fill: themeColors.gold, stroke: haloBg, strokeWidth: 4 })
    ]
  });

  return html`<div class="profile-charts">
    <div class="chart-row-full">
      <div class="cell">
        <div class="chart-title">ELO-stig</div>
        ${eloChart}
      </div>
    </div>
    <div class="dashboard-grid">
      <div class="cell">
        <div class="chart-title">Sæti</div>
        ${placementChart}
      </div>
      <div class="cell">
        <div class="chart-title">Sigurhlutfall</div>
        ${winrateChart}
      </div>
    </div>
    <div class="dashboard-grid">
      ${gammaChart ? html`<div class="cell">
        <div class="chart-title">Kubbastyrkur yfir tíma</div>
        ${gammaChart}
      </div>` : html``}
      <div class="cell">
        <div class="chart-title">Fjöldi leikja</div>
        ${gamesChart}
      </div>
    </div>
  </div>`;
}
```
